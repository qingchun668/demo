<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>OpenClash + HTTPä»£ç†æµ‹é€Ÿå·¥å…·</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f7f9fc; color: #333; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      border: 1px solid #e0e0e0;
      text-align: center;
    }
    th {
      background-color: #eaf3ff;
    }
    h2, h3 {
      margin: 10px 0;
    }
    button {
      padding: 8px 16px;
      margin-top: 15px;
      font-size: 16px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .bold { font-weight: bold; }
    .summary-box {
      background: #fff;
      padding: 16px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    iframe { width: 0; height: 0; border: none; }
  </style>

<script>
function queryIPData() {
  const request = new XMLHttpRequest();
  request.open('GET', 'https://api.ipdata.co/?api-key=2d34f831e30f7fbfde38172435687fb9b62a3b1a5ab03e422fbeea40'); // æ›¿æ¢ APIKEY
  request.setRequestHeader('Accept', 'application/json');

  request.onreadystatechange = function () {
    if (this.readyState === 4 && this.status === 200) {
      try {
        const data = JSON.parse(this.responseText);
        const ipInfoBox = document.createElement("div");
        ipInfoBox.className = "summary-box";
        ipInfoBox.innerHTML = `
          <h3>ğŸŒ å½“å‰ IP ä¿¡æ¯ï¼ˆæ¥è‡ª ipdata.coï¼‰</h3>
          <ul>
            <li><strong>IPï¼š</strong>${data.ip}</li>
            <li><strong>å›½å®¶/åœ°åŒºï¼š</strong>${data.country_name} (${data.country_code})</li>
            <li><strong>åœ°åŒºï¼š</strong>${data.region} - ${data.city}</li>
            <li><strong>ISPï¼š</strong>${data.asn.name}</li>
            <li><strong>ASNï¼š</strong>${data.asn.asn}</li>
            <li><strong>ç»„ç»‡ï¼š</strong>${data.organisation}</li>
            <li><strong>Trust Scoreï¼š</strong>${data.trust_score ?? 'æœªçŸ¥'}</li>
          </ul>
        `;
        document.body.insertBefore(ipInfoBox, document.body.firstChild);
      } catch (e) {
        console.error("IPData å“åº”è§£æå¤±è´¥", e);
      }
    }
  };

  request.send();
}

// é¡µé¢åŠ è½½åæ‰§è¡Œ
queryIPData();
</script>




  
</head>
<body>
  <h2>ğŸ§ª OpenClash + HTTP ä»£ç†æµ‹é€Ÿå·¥å…·</h2>
  <p>é¡µé¢å°†è‡ªåŠ¨è¿›è¡Œæµ‹é€Ÿï¼Œè¯·ç¨ç­‰å‡ ç§’...</p>
  <pre id="output">æµ‹è¯•ä¸­...</pre>
  <button onclick="resetTest()">ğŸ”„ é‡æ–°æ£€æµ‹</button>
  <iframe id="testFrame"></iframe>

  <div id="summary" class="summary-box"></div>

  <script>
    const output = document.getElementById("output");
    const iframe = document.getElementById("testFrame");
    const summaryDiv = document.getElementById("summary");
    let metricsList = [];
    let ipInfoFromTestPage = null;
    const TEST_URL = "https://qingchun668.github.io/demo/testpage.html";

    function format(ms) {
      return `${ms.toFixed(2)} ms`;
    }

    function median(values) {
      if (values.length === 0) return 0;
      values.sort((a, b) => a - b);
      const mid = Math.floor(values.length / 2);
      return values.length % 2 === 0 ? (values[mid - 1] + values[mid]) / 2 : values[mid];
    }

    function stddev(values) {
      const avg = values.reduce((a, b) => a + b) / values.length;
      const squareDiffs = values.map(x => (x - avg) ** 2);
      return Math.sqrt(squareDiffs.reduce((a, b) => a + b) / values.length);
    }

    function startTest() {
      iframe.src = `${TEST_URL}?t=${Date.now()}`;
    }

    function resetTest() {
      metricsList = [];
      summaryDiv.innerHTML = '';
      output.textContent = 'æ­£åœ¨é‡æ–°å¼€å§‹æµ‹é€Ÿ...';
      startTest();
    }

    function showSummary() {
      const totalTimes = metricsList.map(m => m.TotalLoad);
      const avg = totalTimes.reduce((sum, t) => sum + t, 0) / totalTimes.length;
      const med = median(totalTimes);
      const dev = stddev(totalTimes);

      let html = `<h3>ğŸŒ å½“å‰å‡ºå£ IP: ${ipInfoFromTestPage ? ipInfoFromTestPage.ip : "æœªçŸ¥"}</h3>`;
      html += `<table><thead><tr><th>æµ‹è¯•æ¬¡æ•°</th><th>ç½‘é¡µåŠ è½½æ€»æ—¶é—´</th></tr></thead><tbody>`;

      totalTimes.forEach((t, i) => {
        html += `<tr><td>ç¬¬ ${i + 1} æ¬¡</td><td>${format(t)}</td></tr>`;
      });

      html += `</tbody></table>`;
      html += `<h3 class="bold">ğŸ“Š ç»Ÿè®¡ç»“æœï¼š</h3>
        <ul>
          <li>å¹³å‡åŠ è½½æ—¶é—´ï¼š<b>${format(avg)}</b></li>
          <li>ä¸­ä½åŠ è½½æ—¶é—´ï¼ˆæ¨èå‚è€ƒï¼‰ï¼š<b>${format(med)}</b></li>
          <li>æ ‡å‡†å·®ï¼ˆæ³¢åŠ¨æ€§ï¼‰ï¼š<b>${format(dev)}</b></li>
        </ul>`;

      summaryDiv.innerHTML = html;
      output.textContent = 'æµ‹é€Ÿå®Œæˆï¼';
    }

    window.addEventListener("message", (e) => {
      const data = e.data;
      if (!data || typeof data.TotalLoad !== "number") return;
      metricsList.push({ TotalLoad: data.TotalLoad });

      if (data.ipinfo && !ipInfoFromTestPage) {
        ipInfoFromTestPage = data.ipinfo;
      }

      output.textContent = `å·²å®Œæˆ ${metricsList.length} / 5 æ¬¡æµ‹é€Ÿ...`;
      if (metricsList.length < 5) {
        setTimeout(startTest, 500);
      } else {
        showSummary();
      }
    });

    startTest();
  </script>
</body>
</html>
